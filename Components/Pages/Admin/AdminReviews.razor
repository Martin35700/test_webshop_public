@page "/admin/reviews"
@using Microsoft.EntityFrameworkCore
@using webshop.Data
@using webshop.Models
@inject IDbContextFactory<AppDbContext> DbFactory
@inject NavigationManager Nav
@inject IJSRuntime JS
@using Microsoft.AspNetCore.Authorization
@attribute [Authorize(Roles = "Admin")]
@rendermode InteractiveServer

<div class="container py-4">
    @* FEJLÉC ÉS ÖSSZESÍTŐ *@
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h2 class="fw-bold m-0"><i class="bi bi-shield-check me-2 text-primary"></i>Vélemények moderálása</h2>
        <div class="d-flex gap-2">
            <span class="badge bg-warning text-dark rounded-pill px-3 py-2 shadow-sm">
                <i class="bi bi-hourglass-split me-1"></i> Várakozik: @(allReviews?.Count(r => !r.IsApproved) ?? 0)
            </span>
            <span class="badge bg-success rounded-pill px-3 py-2 shadow-sm">
                <i class="bi bi-check-all me-1"></i> Jóváhagyva: @(allReviews?.Count(r => r.IsApproved) ?? 0)
            </span>
        </div>
    </div>

    @if (allReviews == null)
    {
        <div class="text-center py-5">
            <div class="spinner-border text-primary" role="status"></div>
            <p class="mt-2 text-muted">Vélemények betöltése...</p>
        </div>
    }
    else if (!allReviews.Any())
    {
        <div class="card border-0 shadow-sm rounded-4 p-5 text-center">
            <i class="bi bi-chat-square-quote fs-1 text-muted opacity-25"></i>
            <p class="mt-3 text-muted">Még nem érkezett vélemény egyetlen termékhez sem.</p>
        </div>
    }
    else
    {
        <div class="card border-0 shadow-sm rounded-4 overflow-hidden">
            <div class="table-responsive">
                <table class="table table-hover align-middle mb-0">
                    <thead class="bg-dark text-white">
                        <tr>
                            <th class="ps-4 py-3">Állapot</th>
                            <th>Vásárló / Dátum</th>
                            <th>Termék</th>
                            <th>Értékelés</th>
                            <th style="width: 30%;">Vélemény</th>
                            <th class="text-end pe-4">Műveletek</th>
                        </tr>
                    </thead>
                    <tbody>
                        @foreach (var review in allReviews)
                        {
                            <tr class="@(!review.IsApproved ? "table-warning border-start border-warning border-4" : "")">
                                <td class="ps-4">
                                    @if (review.IsApproved)
                                    {
                                        <span class="badge bg-success-subtle text-success border border-success-subtle rounded-pill">
                                            <i class="bi bi-eye-fill me-1"></i> Publikus
                                        </span>
                                    }
                                    else
                                    {
                                        <span class="badge bg-warning text-dark rounded-pill animate__animated animate__pulse animate__infinite">
                                            <i class="bi bi-clock-history me-1"></i> Jóváhagyásra vár
                                        </span>
                                    }
                                </td>
                                <td>
                                    <div class="fw-bold">@review.UserName</div>
                                    @* ADMIN SZÁMÁRA LÁTHATÓ EMAIL *@
                                    <div class="small text-muted">
                                        <i class="bi bi-envelope me-1"></i> @GetEmailByUserId(review.UserId)
                                    </div>
                                    <small class="text-muted d-block mt-1">@review.CreatedAt.ToString("yyyy.MM.dd. HH:mm")</small>
                                </td>
                                <td>
                                    <div class="fw-semibold text-primary">@review.Product?.Name</div>
                                    <small class="text-muted">ID: @review.ProductId</small>
                                </td>
                                <td>
                                    <div class="text-warning">
                                        @for (int i = 1; i <= 5; i++)
                                        {
                                            <i class="bi @(i <= review.Rating ? "bi-star-fill" : "bi-star")"></i>
                                        }
                                    </div>
                                </td>
                                <td>
                                    <div class="small text-muted" style="white-space: pre-wrap; max-height: 80px; overflow-y: auto;">
                                        @review.Comment
                                    </div>
                                </td>
                                <td class="text-end pe-4">
                                    <div class="btn-group shadow-sm bg-white rounded-3">
                                        @if (!review.IsApproved)
                                        {
                                            <button class="btn btn-success btn-sm px-3" title="Jóváhagyás és publikálás" @onclick="() => UpdateApproval(review, true)">
                                                <i class="bi bi-check-lg me-1"></i> Jóváhagyás
                                            </button>
                                        }
                                        else
                                        {
                                            <button class="btn btn-outline-warning btn-sm px-3" title="Visszavonás (Elrejtés)" @onclick="() => UpdateApproval(review, false)">
                                                <i class="bi bi-eye-slash me-1"></i> Elrejtés
                                            </button>
                                        }
                                        @*@<button class="btn btn-outline-danger btn-sm px-3" title="Végleges törlés" @onclick="() => DeleteReview(review)">
                                            <i class="bi bi-trash"></i>
                                        </button>*@
                                    </div>
                                </td>
                            </tr>
                        }
                    </tbody>
                </table>
            </div>
        </div>
    }
</div>

@code {
    private List<ProductReview>? allReviews;
    private List<ApplicationUser> allUsers = new();

    protected override async Task OnInitializedAsync() => await LoadReviews();

    private async Task LoadReviews()
    {
        using var context = DbFactory.CreateDbContext();

        allReviews = await context.ProductReviews
            .Include(r => r.Product)
            .OrderByDescending(r => r.CreatedAt)
            .ToListAsync();

        // Felhasználók betöltése a táblázatban megjelenítendő e-mailekhez
        allUsers = await context.Users.ToListAsync();
    }

    private string GetEmailByUserId(string? userId)
    {
        if (string.IsNullOrEmpty(userId)) return "Vendég / Nincs adat";
        var user = allUsers.FirstOrDefault(u => u.Id == userId);
        return user?.Email ?? "Nincs adat";
    }

    private async Task UpdateApproval(ProductReview review, bool approved)
    {
        using var context = DbFactory.CreateDbContext();
        var dbReview = await context.ProductReviews.FindAsync(review.Id);
        if (dbReview != null)
        {
            dbReview.IsApproved = approved;
            await context.SaveChangesAsync();
            await LoadReviews();
        }
    }

    /*private async Task DeleteReview(ProductReview review)
    {
        var confirmed = await JS.InvokeAsync<bool>("confirm", new object[] { "Biztosan véglegesen törölni szeretné ezt a véleményt?" });
        if (!confirmed) return;

        using var context = DbFactory.CreateDbContext();
        var dbReview = await context.ProductReviews.FindAsync(review.Id);
        if (dbReview != null)
        {
            context.ProductReviews.Remove(dbReview);
            await context.SaveChangesAsync();
            await LoadReviews();
        }
    }*/
}