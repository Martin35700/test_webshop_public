@page "/Account/Register"
@using Microsoft.AspNetCore.Identity
@using System.ComponentModel.DataAnnotations
@using webshop.Models
@using webshop.Services
@inject UserManager<ApplicationUser> UserManager
@inject NavigationManager NavigationManager
@inject EmailService EmailService
@rendermode InteractiveServer

<div class="container py-5">
    <div class="row justify-content-center">
        <div class="col-md-8 card shadow-lg border-0 rounded-4 p-4 p-md-5">

            @if (isRegistrationSuccess)
            {
                <div class="text-center py-4">
                    <div class="bg-success bg-opacity-10 rounded-circle d-inline-flex align-items-center justify-content-center mb-4" style="width: 90px; height: 90px;">
                        <i class="bi bi-person-check-fill fs-1 text-success"></i>
                    </div>
                    <h2 class="fw-bold mb-3">Sikeres regisztráció!</h2>
                    <p class="text-muted mb-4 px-lg-5">
                        Kedves <strong>@Input.FullName</strong>, fiókja elkészült! <br />
                        Az üdvözlő e-mailt elküldtük a(z) <strong>@Input.Email</strong> címre.
                        Most már bejelentkezhet és leadhatja első rendelését.
                    </p>
                    <div class="d-grid gap-2 col-lg-6 mx-auto">
                        <a href="Account/Login" class="btn btn-primary btn-lg rounded-pill fw-bold shadow-sm">
                            Tovább a belépéshez
                        </a>
                    </div>
                </div>
            }
            else
            {
                <div class="text-center mb-4">
                    <h3 class="fw-bold">Fiók létrehozása</h3>
                    <p class="text-muted small">Adja meg adatait a gyorsabb vásárlás érdekében.</p>
                </div>

                @if (errors.Any())
                {
                    <div class="alert alert-danger rounded-4 border-0 shadow-sm animate__animated animate__shakeX mb-4">
                        <div class="d-flex align-items-center mb-2">
                            <i class="bi bi-exclamation-triangle-fill me-2 fs-5"></i>
                            <strong>Hiba történt:</strong>
                        </div>
                        <ul class="mb-0 small ps-3">
                            @foreach (var error in errors)
                            {
                                <li>@error</li>
                            }
                        </ul>
                    </div>
                }

                <EditForm Model="Input" OnValidSubmit="HandleRegister" FormName="registerForm" Method="post">
                    <DataAnnotationsValidator />

                    @* --- 1. SZEMÉLYES ADATOK --- *@
                    <h6 class="text-primary fw-bold text-uppercase border-bottom pb-2 mb-3">
                        <i class="bi bi-person-vcard me-2"></i>Személyes adatok
                    </h6>
                    <div class="row g-3 mb-4">
                        <div class="col-12">
                            <label class="form-label fw-semibold small text-muted text-uppercase">Teljes név</label>
                            <InputText @bind-Value="Input.FullName" class="form-control form-control-lg rounded-3 bg-light border-0 shadow-none" placeholder="Gipsz Jakab" />
                            <ValidationMessage For="() => Input.FullName" class="text-danger small" />
                        </div>
                        <div class="col-12">
                            <label class="form-label fw-semibold small text-muted text-uppercase">Telefonszám</label>
                            <InputText @bind-Value="Input.PhoneNumber" class="form-control form-control-lg rounded-3 bg-light border-0 shadow-none" placeholder="+36 30 123 4567" />
                            <ValidationMessage For="() => Input.PhoneNumber" class="text-danger small" />
                        </div>
                    </div>

                    @* --- 2. SZÁLLÍTÁSI CÍM --- *@
                    <h6 class="text-primary fw-bold text-uppercase border-bottom pb-2 mb-3">
                        <i class="bi bi-truck me-2"></i>Szállítási adatok
                    </h6>
                    <div class="row g-3 mb-4">
                        <div class="col-md-4">
                            <label class="form-label fw-semibold small text-muted text-uppercase">Irányítószám</label>
                            <InputText @bind-Value="Input.Zip" class="form-control rounded-3 shadow-none bg-light border-0" placeholder="1234" />
                            <ValidationMessage For="() => Input.Zip" class="text-danger small" />
                        </div>
                        <div class="col-md-8">
                            <label class="form-label fw-semibold small text-muted text-uppercase">Város</label>
                            <InputText @bind-Value="Input.City" class="form-control rounded-3 shadow-none bg-light border-0" placeholder="Budapest" />
                            <ValidationMessage For="() => Input.City" class="text-danger small" />
                        </div>
                        <div class="col-12">
                            <label class="form-label fw-semibold small text-muted text-uppercase">Utca, házszám</label>
                            <InputText @bind-Value="Input.Address" class="form-control rounded-3 shadow-none bg-light border-0" placeholder="Példa utca 12. 2. em." />
                            <ValidationMessage For="() => Input.Address" class="text-danger small" />
                        </div>
                    </div>

                    @* --- 3. SZÁMLÁZÁSI CÍM --- *@
                    <h6 class="text-primary fw-bold text-uppercase border-bottom pb-2 mb-3">
                        <i class="bi bi-receipt me-2"></i>Számlázási adatok
                    </h6>

                    <div class="form-check form-switch mb-4 p-3 bg-light rounded-4 border-0 d-flex align-items-center">
                        <InputCheckbox @bind-Value="Input.BillingSameAsShipping" class="form-check-input ms-0 me-3" id="billingCheck" style="cursor: pointer; width: 3em; height: 1.5em;" />
                        <label class="form-check-label fw-semibold" for="billingCheck" style="cursor: pointer;">
                            A számlázási cím megegyezik a szállítási címmel
                        </label>
                    </div>

                    @if (!Input.BillingSameAsShipping)
                    {
                        <div class="row g-3 mb-4 animate__animated animate__fadeIn">
                            <div class="col-md-4">
                                <label class="form-label fw-semibold small text-muted text-uppercase">Számlázási Irányítószám</label>
                                <InputText @bind-Value="Input.BillingZip" class="form-control rounded-3 shadow-none bg-light border-0" placeholder="1234" />
                            </div>
                            <div class="col-md-8">
                                <label class="form-label fw-semibold small text-muted text-uppercase">Számlázási Város</label>
                                <InputText @bind-Value="Input.BillingCity" class="form-control rounded-3 shadow-none bg-light border-0" placeholder="Budapest" />
                            </div>
                            <div class="col-12">
                                <label class="form-label fw-semibold small text-muted text-uppercase">Számlázási Cím (utca, házszám)</label>
                                <InputText @bind-Value="Input.BillingAddress" class="form-control rounded-3 shadow-none bg-light border-0" />
                            </div>
                        </div>
                    }

                    @* --- 4. FIÓK ADATOK --- *@
                    <h6 class="text-primary fw-bold text-uppercase border-bottom pb-2 mb-3 mt-5">
                        <i class="bi bi-shield-lock me-2"></i>Belépési adatok
                    </h6>
                    <div class="row g-3 mb-4">
                        <div class="col-12">
                            <label class="form-label fw-semibold small text-muted text-uppercase">E-mail cím</label>
                            <InputText @bind-Value="Input.Email" class="form-control rounded-3 shadow-none bg-light border-0" placeholder="pelda@email.hu" />
                            <ValidationMessage For="() => Input.Email" class="text-danger small" />
                        </div>
                        <div class="col-md-6">
                            <label class="form-label fw-semibold small text-muted text-uppercase">Jelszó</label>
                            <InputText @bind-Value="Input.Password" type="password" class="form-control rounded-3 shadow-none bg-light border-0" />
                            <ValidationMessage For="() => Input.Password" class="text-danger small" />
                        </div>
                        <div class="col-md-6">
                            <label class="form-label fw-semibold small text-muted text-uppercase">Jelszó megerősítése</label>
                            <InputText @bind-Value="Input.ConfirmPassword" type="password" class="form-control rounded-3 shadow-none bg-light border-0" />
                            <ValidationMessage For="() => Input.ConfirmPassword" class="text-danger small" />
                        </div>
                    </div>

                    <button type="submit" class="btn btn-primary w-100 rounded-pill py-3 fw-bold shadow-lg hover-scale mt-3" disabled="@isSubmitting">
                        @if (isSubmitting)
                        {
                            <span class="spinner-border spinner-border-sm me-2"></span>
                            <span>Fiók létrehozása...</span>
                        }
                        else
                        {
                            <span><i class="bi bi-check2-circle me-2"></i>Regisztráció befejezése</span>
                        }
                    </button>
                </EditForm>

                <div class="text-center mt-4 pt-3 border-top">
                    <span class="text-muted">Már van fiókja?</span>
                    <a href="Account/Login" class="text-decoration-none fw-bold ms-1">Jelentkezzen be itt</a>
                </div>
            }
        </div>
    </div>
</div>

<style>
    .form-check-input:checked {
        background-color: #0d6efd;
        border-color: #0d6efd;
    }

    .hover-scale {
        transition: transform 0.2s ease;
    }

        .hover-scale:hover {
            transform: scale(1.01);
        }
</style>

@code {
    [SupplyParameterFromForm]
    public RegisterInput Input { get; set; } = new();

    private List<string> errors = new();
    private bool isRegistrationSuccess = false;
    private bool isSubmitting = false;

    protected override void OnInitialized()
    {
        // Biztosítjuk az alapértelmezett állapotot
        Input ??= new();
    }

    private async Task HandleRegister()
    {
        isSubmitting = true;
        errors.Clear();

        // 1. Manuális validáció a számlázási címre, ha NEM egyezik meg
        if (!Input.BillingSameAsShipping)
        {
            if (string.IsNullOrWhiteSpace(Input.BillingZip) ||
                string.IsNullOrWhiteSpace(Input.BillingCity) ||
                string.IsNullOrWhiteSpace(Input.BillingAddress))
            {
                errors.Add("Kérjük, töltse ki az összes számlázási mezőt, vagy jelölje be a 'megegyezik' opciót.");
                isSubmitting = false;
                return;
            }

            if (!System.Text.RegularExpressions.Regex.IsMatch(Input.BillingZip, @"^[0-9]{4}$"))
            {
                errors.Add("A számlázási irányítószám formátuma érvénytelen.");
                isSubmitting = false;
                return;
            }
        }

        // 2. Felhasználó objektum összeállítása
        var user = new ApplicationUser
        {
            UserName = Input.Email,
            Email = Input.Email,
            FullName = Input.FullName,
            PhoneNumber = Input.PhoneNumber,

            // Szállítási adatok
            Zip = Input.Zip,
            City = Input.City,
            Address = Input.Address,

            // Számlázási adatok logikája
            BillingZip = Input.BillingSameAsShipping ? Input.Zip : Input.BillingZip,
            BillingCity = Input.BillingSameAsShipping ? Input.City : Input.BillingCity,
            BillingAddress = Input.BillingSameAsShipping ? Input.Address : Input.BillingAddress
        };

        var result = await UserManager.CreateAsync(user, Input.Password);

        if (result.Succeeded)
        {
            try
            {
                await EmailService.SendWelcomeEmailAsync(Input.Email, Input.FullName);
            }
            catch (Exception ex)
            {
                Console.WriteLine($"Email hiba: {ex.Message}");
            }

            isRegistrationSuccess = true;
        }
        else
        {
            errors.AddRange(result.Errors.Select(e => e.Description));
            isSubmitting = false;
        }
    }

    public class RegisterInput
    {
        [Required(ErrorMessage = "A név megadása kötelező")]
        public string FullName { get; set; } = "";

        [Required(ErrorMessage = "A telefonszám megadása kötelező")]
        [RegularExpression(@"^(\+?[0-9\s]{7,18})$", ErrorMessage = "Kérjük, érvényes telefonszámot adjon meg!")]
        public string PhoneNumber { get; set; } = "";

        [Required(ErrorMessage = "Az e-mail megadása kötelező")]
        [EmailAddress(ErrorMessage = "Érvénytelen e-mail formátum")]
        public string Email { get; set; } = "";

        [Required(ErrorMessage = "A jelszó megadása kötelező")]
        [MinLength(6, ErrorMessage = "A jelszónak legalább 6 karakternek kell lennie")]
        public string Password { get; set; } = "";

        [Required(ErrorMessage = "A jelszó megerősítése kötelező")]
        [Compare("Password", ErrorMessage = "A két jelszó nem egyezik meg")]
        public string ConfirmPassword { get; set; } = "";

        [Required(ErrorMessage = "Az irányítószám megadása kötelező")]
        [RegularExpression(@"^[0-9]{4}$", ErrorMessage = "A magyar irányítószám 4 számjegyből áll.")]
        public string Zip { get; set; } = "";

        [Required(ErrorMessage = "A város megadása kötelező")]
        public string City { get; set; } = "";

        [Required(ErrorMessage = "A cím megadása kötelező")]
        [MinLength(5, ErrorMessage = "Kérjük, adjon meg pontosabb címet (utca, házszám).")]
        public string Address { get; set; } = "";

        public bool BillingSameAsShipping { get; set; } = true;

        public string BillingZip { get; set; } = "";
        public string BillingCity { get; set; } = "";
        public string BillingAddress { get; set; } = "";
    }
}