@page "/Account/ForgotPassword"
@using Microsoft.AspNetCore.Identity
@using webshop.Models
@using webshop.Services
@inject UserManager<ApplicationUser> UserManager
@inject EmailService EmailService
@inject NavigationManager NavigationManager
@rendermode InteractiveServer

<PageTitle>Elfelejtett jelszó - Modern Webshop</PageTitle>

<div class="container py-5">
    <div class="row justify-content-center">
        <div class="col-md-5 card shadow-sm border-0 rounded-4 p-4 text-center">
            <h3 class="fw-bold mb-2">Elfelejtett jelszó</h3>
            <p class="text-muted small mb-4">Adja meg e-mail címét, és küldünk egy linket a visszaállításhoz.</p>

            @if (submitted)
            {
                <div class="alert alert-success rounded-4 py-3">
                    <i class="bi bi-envelope-check fs-4 d-block mb-2"></i>
                    Amennyiben a megadott e-mail cím létezik, elküldtük a visszaállításhoz szükséges instrukciókat.
                </div>
                <a href="Account/Login" class="btn btn-outline-dark rounded-pill px-4">Vissza a belépéshez</a>
            }
            else
            {
                <div class="mb-3 text-start">
                    <label class="form-label small fw-bold">E-mail cím</label>
                    <input type="email" class="form-control rounded-3 py-2" @bind="email" placeholder="pelda@email.hu" />
                </div>

                @if (!string.IsNullOrEmpty(error))
                {
                    <div class="text-danger small mb-3 text-start">@error</div>
                }

                <button class="btn btn-primary w-100 rounded-pill py-2 fw-bold" @onclick="HandleSubmit" disabled="@isSubmitting">
                    @if (isSubmitting)
                    {
                        <span class="spinner-border spinner-border-sm me-2"></span>
                    }
                    Link küldése
                </button>
            }
        </div>
    </div>
</div>

@code {
    private string email = "";
    private bool submitted = false;
    private bool isSubmitting = false;
    private string? error;

    private async Task HandleSubmit()
    {
        if (string.IsNullOrWhiteSpace(email) || !email.Contains("@"))
        {
            error = "Kérjük, érvényes e-mail címet adjon meg!";
            return;
        }

        error = null;
        isSubmitting = true;

        var user = await UserManager.FindByEmailAsync(email);

        if (user != null)
        {
            var token = await UserManager.GeneratePasswordResetTokenAsync(user);
            var callbackUrl = NavigationManager.ToAbsoluteUri($"/Account/ResetPassword?email={email}&token={Uri.EscapeDataString(token)}").ToString();

            // Itt hívjuk meg az EmailService-t
            await EmailService.SendPasswordResetEmailAsync(email, callbackUrl);
        }

        // Biztonsági okokból akkor is true, ha nincs user (ne lehessen e-mail címeket halászni)
        submitted = true;
        isSubmitting = false;
    }
}