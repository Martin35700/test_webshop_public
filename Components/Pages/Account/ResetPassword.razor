@page "/Account/ResetPassword"
@using Microsoft.AspNetCore.Identity
@using System.ComponentModel.DataAnnotations
@using webshop.Models
@inject UserManager<ApplicationUser> UserManager
@inject NavigationManager NavigationManager
@rendermode InteractiveServer

<PageTitle>Jelszó visszaállítása - Modern Webshop</PageTitle>

<div class="container py-5">
    <div class="row justify-content-center">
        <div class="col-md-5 card shadow-sm border-0 rounded-4 p-4">
            <h3 class="fw-bold mb-4">Új jelszó beállítása</h3>

            @if (!string.IsNullOrEmpty(error))
            {
                <div class="alert alert-danger small rounded-3">
                    <i class="bi bi-exclamation-circle me-2"></i>@error
                </div>
            }

            <div class="mb-3">
                <label class="form-label small fw-bold">Új jelszó</label>
                <input type="password" class="form-control rounded-3" @bind="password" />
            </div>

            <div class="mb-4">
                <label class="form-label small fw-bold">Megerősítés</label>
                <input type="password" class="form-control rounded-3" @bind="confirmPassword" />
            </div>

            <button class="btn btn-dark w-100 rounded-pill py-2 fw-bold" @onclick="HandleReset">
                Jelszó mentése
            </button>
        </div>
    </div>
</div>

@code {
    [SupplyParameterFromQuery] public string? Email { get; set; }
    [SupplyParameterFromQuery] public string? Token { get; set; }

    private string password = "";
    private string confirmPassword = "";
    private string? error;

    private async Task HandleReset()
    {
        if (string.IsNullOrWhiteSpace(password))
        {
            error = "Kérjük, adjon meg egy új jelszót!";
            return;
        }

        if (password != confirmPassword)
        {
            error = "A két jelszó nem egyezik meg.";
            return;
        }

        if (string.IsNullOrEmpty(Email) || string.IsNullOrEmpty(Token))
        {
            error = "Érvénytelen visszaállító link.";
            return;
        }

        var user = await UserManager.FindByEmailAsync(Email);
        if (user == null)
        {
            // Biztonsági okokból ilyenkor is érdemes visszaküldeni, vagy hibaüzenetet adni
            NavigationManager.NavigateTo("/Account/Login");
            return;
        }

        var result = await UserManager.ResetPasswordAsync(user, Token, password);
        if (result.Succeeded)
        {
            NavigationManager.NavigateTo("/Account/Login?reset=success");
        }
        else
        {
            error = string.Join(", ", result.Errors.Select(e => e.Description));
        }
    }
}